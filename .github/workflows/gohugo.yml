name: CI
on:
   # Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÑŽÑ‚ jobs
    push:
      branches: [ "main" ]
    pull_request:
      branches: [ "main" ]

#permissions:
#  contents: write

jobs: # jobs Ð·Ð°Ð¿ÑƒÑÐºÐ°ÑŽÑ‚ÑÑ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾, ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
  deploy: # ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ job Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ñ‚ÑŒ ÐºÐ°Ðº ÑƒÐ³Ð¾Ð´Ð½Ð¾
    runs-on: ubuntu-22.04 # ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð² Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ðµ, Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÑŽÑ‚ÑÑ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹
#    concurrency:
#      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - name: Git checkout # Actions Ð¾Ñ‚ github: Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹, Ð³Ð¸Ñ‚ Ð¸ Ñ‚.Ð´.
        uses: actions/checkout@v4
        with:
          submodules: true  # Fetch Hugo themes (true OR recursive)
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

#      - name: Update theme
        # (Optional)If you have the theme added as submodule, you can pull it and use the most updated version
#        run: git submodule update --init --recursive


      - name: ðŸ“„ Generate pdf_lastmod.yaml
        run: |
          mkdir -p data
          echo "pdf_lastmod:" > data/pdf_lastmod.yaml
          for f in static/**/*.pdf; do
            filename=$(basename "$f")
            filedate=$(git log -1 --format="%ad" --date=short -- "$f")
            echo "  $filename: \"$filedate\"" >> data/pdf_lastmod.yaml
          done
          cat data/pdf_lastmod.yaml
          ls -R data

      - name: Setup hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.135.0'
          extended: true

      - name: Build
        # remove --minify tag if you do not need it
        # docs: https://gohugo.io/hugo-pipes/minification/
        run: hugo --minify

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.MYSITE_TOKEN }}
          publish_dir: ./public

      - name: ðŸ“‚ Sync Files
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete
          remote_host: lubkov.spbu.ru
          remote_port: ${{ secrets.SSH_PORT }}
          remote_user: ${{ secrets.REM_USER }}
          remote_key: ${{ secrets.SSH_KEY }}
          remote_path: ${{ secrets.DEST_PATH }}
          path: ./public/

      - name: ðŸ“„ Upload lastmod.yaml separately
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr
          remote_host: lubkov.spbu.ru
          remote_port: ${{ secrets.SSH_PORT }}
          remote_user: ${{ secrets.REM_USER }}
          remote_key: ${{ secrets.SSH_KEY }}
          remote_path: ${{ secrets.DEST_PATH }}/data
          path: ./data/

#       website on spbu hosting
#      - name: Set up WireGuard Connection
#        uses: niklaskeerl/easy-wireguard-action@v2
#        with:
#          WG_CONFIG_FILE: ${{ secrets.WG_CONFIG_FILE_SPEEDSTER }}

#      - name: ðŸ“‚ Sync files
#        uses: SamKirkland/FTP-Deploy-Action@4.3.2
#        with:
#          server: ${{ secrets.LINK_FTP_SPBU }}
#          username: ${{ secrets.USERNAME_FPT_SPBU }}
#          password: ${{ secrets.PASS_FTP_SPBU }}
#          local-dir: ./public/


         