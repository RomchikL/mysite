{{- $lines := split .Inner "\n" -}}
<table class="publist">
  <tbody>
  {{- $i := 0 -}}
  {{- range $lines }}
    {{- $line := trim . " \t\r\n" -}}
    {{- if $line }}
      {{- $i = add $i 1 -}}
      {{- $parts := split $line "|" -}}

      {{- $title := trim (index $parts 0) " " -}}
      {{- $pdf   := cond (ge (len $parts) 2) (trim (index $parts 1) " ") "" -}}
      {{- $doi   := cond (ge (len $parts) 3) (trim (index $parts 2) " ") "" -}}
      {{- $arxiv := cond (ge (len $parts) 4) (trim (index $parts 3) " ") "" -}}
      {{- $bibkey := cond (ge (len $parts) 5) (trim (index $parts 4) " ") "" -}}

      {{/* --- BibTeX из data/lubkov.yaml --- */}}
      {{- $bibentry := "" -}}
      {{- if $bibkey }}
        {{- $entry := index site.Data.lubkov $bibkey -}}
        {{- if $entry }}
          {{- $fields := slice -}}
          {{- if $entry.author  }}{{ $fields = $fields | append (printf "  author = {%s}"  $entry.author) }}{{ end }}
          {{- if $entry.title   }}{{ $fields = $fields | append (printf "  title = {%s}"   $entry.title) }}{{ end }}
          {{- if $entry.journal }}{{ $fields = $fields | append (printf "  journal = {%s}" $entry.journal) }}{{ end }}
          {{- if $entry.year    }}{{ $fields = $fields | append (printf "  year = {%s}"    $entry.year) }}{{ end }}
          {{- if $entry.volume  }}{{ $fields = $fields | append (printf "  volume = {%s}"  $entry.volume) }}{{ end }}
          {{- if $entry.number  }}{{ $fields = $fields | append (printf "  number = {%s}"  $entry.number) }}{{ end }}
          {{- if $entry.pages   }}{{ $fields = $fields | append (printf "  pages = {%s}"   $entry.pages) }}{{ end }}
          {{- if $entry.doi     }}{{ $fields = $fields | append (printf "  doi = {%s}"     $entry.doi) }}{{ end }}

          {{- $bibentry = printf "@%s{%s,\n%s\n}" $entry.ENTRYTYPE $bibkey (delimit $fields ",\n") -}}
        {{- end }}
      {{- end }}

      <tr>
        <td class="pub-num">{{ $i }}</td>
        <td class="pub-title">{{ $title | markdownify }}</td>
        <td class="pub-buttons">
          <div class="btn-group">
            {{- if $pdf }}
              <a class="btn btn-pdf" href="{{ $pdf }}" target="_blank">PDF</a>
            {{ else }} <span class="btn-placeholder"></span> {{ end }}

            {{- if $doi }}
              <a class="btn btn-doi" href="{{ $doi }}" target="_blank">DOI</a>
            {{ else }} <span class="btn-placeholder"></span> {{ end }}

            {{- if $arxiv }}
              <a class="btn btn-arxiv" href="{{ $arxiv }}" target="_blank">ArXiv</a>
            {{ else }} <span class="btn-placeholder"></span> {{ end }}

            {{- if $bibentry }}
              <button class="btn btn-bibtex" data-bib="{{ $bibentry }}">BibTeX</button>
            {{ else }} <span class="btn-placeholder"></span> {{ end }}
          </div>
        </td>
      </tr>
    {{- end }}
  {{- end }}
  </tbody>
</table>
